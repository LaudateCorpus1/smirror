init:
  '!gcpCredentials': $params.authWith
  gcp: ${secrets.$gcpCredentials}
  gcpProject: $gcp.ProjectID
  serviceAccount: $gcp.ClientEmail
  gsConfigBucket: ${gcpProject}_config
  awsCredentials: aws-e2e
  s3Secrets: ${secrets.$awsCredentials}


pipeline:

  deployGCPKey:
    action: gcp/kms:deployKey
    credentials: $gcpCredentials
    ring: storagemirror_ring
    key: storagemirror
    purpose: ENCRYPT_DECRYPT
    logging: false
    bindings:
      - role: roles/cloudkms.cryptoKeyEncrypterDecrypter
        members:
          - serviceAccount:${gcp.serviceAccount}

  info:
    action: print
    message: $AsString($s3Secrets)

  encryptS3Credentials:
    action: gcp/kms:encrypt
    ring: storagemirror_ring
    key: storagemirror
    plainData: $AsJSON($s3Secrets)
    dest:
      URL: gs://${gsConfigBucket}/Secrets/s3-ms.json.enc
      credentials: ${gcpCredentials}
    logging: false
